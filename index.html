<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>סקי ווידאו עם מהירות בזמן אמת</title>

  <!-- SEO -->
  <meta name="description" content="אפליקציית וידאו לסקי שמציגה מהירות בזמן אמת על המסך ושומרת את הסרטון עם המד. מותאם מובייל, תומך PWA." />
  <meta name="keywords" content="סקי, סנובורד, מצלמה, מהירות, GPS, וידאו, גלישה, PWA, ski, snowboard, speed overlay" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <meta name="theme-color" content="#000000" />
  <!-- כאן תדביק מטא של גוגל -->
  <!-- <meta name="google-site-verification" content="XXXXXX" /> -->

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <style>
    :root {
      --hud-bg: rgba(255,255,255,0.9);
      --hud-text: #000000;
      --seg-off: rgba(0,0,0,0.08);
      --seg-on-green: #3bd385;
      --seg-on-cyan: #00c8ff;
      --seg-on-blue: #2b7cff;
      --seg-on-red: #ff4a4a;
      --seg-on-black: #000;
    }
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      overscroll-behavior: none;
      min-height: 100vh;
    }
    .app {
      position: fixed;
      inset: 0;
      background: #000;
      overflow: hidden;
    }
    video#cam {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #000;
    }
    canvas#rec {
      display: none;
    }

    /* הודעה שמחשב לא נתמך */
    .desktop-block {
      position: fixed;
      inset: 0;
      background: #000;
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
      z-index: 9999;
      font-size: 16px;
      line-height: 1.5;
    }

    /* הוראות פתיחה */
    .intro-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.78);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    .intro-box {
      background: #fff;
      color: #000;
      border-radius: 16px;
      width: min(90%, 360px);
      padding: 20px 16px 16px 16px;
      text-align: center;
      box-shadow: 0 14px 40px rgba(0,0,0,0.35);
    }
    .intro-title {
      font-weight: 700;
      margin-bottom: 10px;
      font-size: 17px;
    }
    .intro-text {
      font-size: 13px;
      line-height: 1.4;
      margin-bottom: 16px;
    }
    .intro-btn {
      display: inline-block;
      background: #000;
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
    }

    /* HUD מהירות */
    .hud {
      position: absolute;
      top: 16%;
      left: 10px;
      width: 140px;
      background: var(--hud-bg);
      border-radius: 18px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      padding: 10px 10px 14px 10px;
      z-index: 50;
      touch-action: none;
      transform-origin: top left;
    }
    .hud-header {
      font-size: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: rgba(0,0,0,0.55);
      margin-bottom: 3px;
    }
    .hud-speed-row {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      margin-bottom: 8px;
    }
    .hud-value {
      font-size: 38px;
      line-height: 0.9;
      font-weight: 700;
      color: var(--hud-text);
    }
    .hud-unit {
      font-size: 11px;
      font-weight: 600;
      color: rgba(0,0,0,0.55);
      margin-bottom: 4px;
    }
    .hud-segments {
      display: flex;
      flex-direction: column;
      gap: 4px;
      width: 9px;
      margin-left: auto;
    }
    .hud-segment {
      width: 100%;
      height: 20px;
      border-radius: 999px;
      background: var(--seg-off);
    }
    /* כפתורי הקלטה */
    .controls {
      position: absolute;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      z-index: 60;
    }
    .rec-btn {
      width: 78px;
      height: 78px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #00d1ff 0%, #0066ff 75%);
      border: 3px solid rgba(255,255,255,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 8px 22px rgba(0,119,255,0.4);
    }
    .rec-btn svg {
      width: 30px;
      height: 30px;
      fill: #fff;
    }
    .stop-btn {
      width: 78px;
      height: 78px;
      border-radius: 18px;
      background: rgba(0,0,0,0.35);
      border: 2px solid rgba(255,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .stop-btn svg {
      width: 26px;
      height: 26px;
      fill: #ff4444;
    }
    .hidden { display: none !important; }

    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 9px 14px;
      border-radius: 8px;
      font-size: 13px;
      display: none;
      z-index: 2000;
    }
  </style>
</head>
<body>
  <div class="desktop-block" id="desktopBlock">
    האפליקציה הזו נועדה לשימוש במובייל בלבד (iPhone / Android).<br>
    פתח את הקישור מהטלפון שלך.
  </div>

  <div class="app" id="app">
    <video id="cam" playsinline autoplay muted></video>
    <canvas id="rec" width="1280" height="720"></canvas>

    <!-- HUD -->
    <div id="hud" class="hud">
      <div class="hud-header">LIVE SPEED</div>
      <div class="hud-speed-row">
        <div>
          <div id="hudVal" class="hud-value">0</div>
          <div class="hud-unit">KM/H</div>
        </div>
        <div class="hud-segments">
          <div id="seg1" class="hud-segment"></div>
          <div id="seg2" class="hud-segment"></div>
          <div id="seg3" class="hud-segment"></div>
          <div id="seg4" class="hud-segment"></div>
          <div id="seg5" class="hud-segment"></div>
        </div>
      </div>
    </div>

    <!-- בקרות -->
    <div class="controls">
      <div id="btnRec" class="rec-btn" title="התחל הקלטה">
        <!-- play -->
        <svg viewBox="0 0 24 24">
          <path d="M8 5v14l11-7z" />
        </svg>
      </div>
      <div id="btnStop" class="stop-btn hidden" title="עצור ושמור">
        <svg viewBox="0 0 24 24">
          <rect x="6" y="6" width="12" height="12" rx="1" />
        </svg>
      </div>
    </div>

    <!-- הוראות -->
    <div id="intro" class="intro-overlay">
      <div class="intro-box">
        <div class="intro-title">איך מצלמים?</div>
        <div class="intro-text">
          אפשר מצלמה ומיקום.<br>
          גרור את מד המהירות למקום על המסך.<br>
          דאבל־טאץ’ על המד כדי להגדיל/להקטין.<br>
          לחץ על הכפתור התחתון כדי להתחיל הקלטה.
        </div>
        <button id="introBtn" class="intro-btn">הבנתי, תן לי להתחיל</button>
      </div>
    </div>

    <div id="toast" class="toast">הוידאו מוכן. אם אתה ב-iPhone תפתח ותשמור ידנית.</div>
  </div>

  <script>
    // ======== זיהוי מחשב ========
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const desktopBlock = document.getElementById('desktopBlock');
    if (!isMobile) {
      desktopBlock.style.display = 'flex';
    }

    // ======== אלמנטים ========
    const cam = document.getElementById('cam');
    const canvas = document.getElementById('rec');
    const ctx = canvas.getContext('2d');
    const hud = document.getElementById('hud');
    const hudVal = document.getElementById('hudVal');
    const segs = [
      document.getElementById('seg1'),
      document.getElementById('seg2'),
      document.getElementById('seg3'),
      document.getElementById('seg4'),
      document.getElementById('seg5')
    ];
    const btnRec = document.getElementById('btnRec');
    const btnStop = document.getElementById('btnStop');
    const intro = document.getElementById('intro');
    const introBtn = document.getElementById('introBtn');
    const toast = document.getElementById('toast');

    let latestSpeed = 0;
    let recording = false;
    let mediaRecorder = null;
    let chunks = [];
    let draggingHud = false;
    let dragOffsetX = 0, dragOffsetY = 0;
    let hudScaleIdx = 1; // 0=קטן,1=רגיל,2=גדול
    const hudScales = [0.8, 1, 1.25];

    // ======== פתיחת מצלמה ========
    async function startCam() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' },
          audio: true
        });
        cam.srcObject = stream;
        cam.onloadedmetadata = () => {
          cam.play();
          // שים את הקנבס על אותו יחס כדי שלא יתמתח
          canvas.width = cam.videoWidth || 1280;
          canvas.height = cam.videoHeight || 720;
        };
        drawLoop();
      } catch (e) {
        alert('לא ניתן לפתוח מצלמה. בדוק הרשאות.');
      }
    }
    startCam();

    // ======== בקשת GPS אחרי פעולה ========
    function requestGeo() {
      if (!("geolocation" in navigator)) return;
      navigator.geolocation.watchPosition(onGeo, err => {
        console.log('geo err', err);
      }, {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 8000
      });
    }

    introBtn.addEventListener('click', () => {
      intro.style.display = 'none';
      localStorage.setItem('ski_intro_done', '1');
      requestGeo();
    });

    // אם כבר ראה פעם
    if (localStorage.getItem('ski_intro_done') === '1') {
      intro.style.display = 'none';
      requestGeo();
    }

    // ======== GPS ========
    let lastGeo = null;
    function onGeo(pos) {
      const { latitude, longitude, speed } = pos.coords;
      let kmh = 0;
      if (speed != null) {
        kmh = speed * 3.6;
      } else if (lastGeo) {
        // חישוב לפי מרחק
        const distKm = haversine(lastGeo.lat, lastGeo.lon, latitude, longitude);
        const dt = (pos.timestamp - lastGeo.t) / 1000;
        if (dt > 0) kmh = (distKm / (dt / 3600));
      }
      // פילטר שיהיה חלק
      latestSpeed = Math.round(kmh * 0.6 + latestSpeed * 0.4);
      updateHUD(latestSpeed);
      lastGeo = { lat: latitude, lon: longitude, t: pos.timestamp };
    }
    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function updateHUD(kmh) {
      hudVal.textContent = kmh;
      // איפוס צבעים
      segs.forEach(s => s.style.background = 'var(--seg-off)');
      // הדלקה לפי טווחים
      if (kmh > 0) segs[0].style.background = 'var(--seg-on-green)';
      if (kmh >= 25) segs[1].style.background = 'var(--seg-on-cyan)';
      if (kmh >= 45) segs[2].style.background = 'var(--seg-on-blue)';
      if (kmh >= 70) segs[3].style.background = 'var(--seg-on-red)';
      if (kmh >= 100) segs[4].style.background = 'var(--seg-on-black)';
    }

    // ======== גרירת HUD ========
    hud.addEventListener('mousedown', startHudDrag);
    hud.addEventListener('touchstart', startHudDrag, {passive:false});
    function startHudDrag(e) {
      draggingHud = true;
      const rect = hud.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      dragOffsetX = clientX - rect.left;
      dragOffsetY = clientY - rect.top;
      e.preventDefault();
    }
    document.addEventListener('mousemove', hudDragMove);
    document.addEventListener('touchmove', hudDragMove, {passive:false});
    function hudDragMove(e) {
      if (!draggingHud) return;
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      let newLeft = clientX - dragOffsetX;
      let newTop = clientY - dragOffsetY;
      const maxLeft = window.innerWidth - hud.offsetWidth;
      const maxTop = window.innerHeight - hud.offsetHeight;
      if (newLeft < 0) newLeft = 0;
      if (newTop < 0) newTop = 0;
      if (newLeft > maxLeft) newLeft = maxLeft;
      if (newTop > maxTop) newTop = maxTop;
      hud.style.left = newLeft + 'px';
      hud.style.top = newTop + 'px';
      saveHudPos();
    }
    document.addEventListener('mouseup', () => draggingHud = false);
    document.addEventListener('touchend', () => draggingHud = false);

    // דאבל־טאץ’ להגדלה/הקטנה
    let lastTap = 0;
    hud.addEventListener('touchend', (e) => {
      const now = Date.now();
      if (now - lastTap < 300) {
        // דאבל
        hudScaleIdx = (hudScaleIdx + 1) % hudScales.length;
        hud.style.transform = `scale(${hudScales[hudScaleIdx]})`;
        saveHudPos();
      }
      lastTap = now;
    });

    // שמירה
    function saveHudPos() {
      const r = hud.getBoundingClientRect();
      localStorage.setItem('ski_hud_pos', JSON.stringify({
        left: r.left,
        top: r.top,
        scale: hudScales[hudScaleIdx]
      }));
    }
    // שחזור
    const saved = localStorage.getItem('ski_hud_pos');
    if (saved) {
      const d = JSON.parse(saved);
      hud.style.left = d.left + 'px';
      hud.style.top = d.top + 'px';
      hud.style.transform = `scale(${d.scale})`;
      hudScaleIdx = hudScales.indexOf(d.scale);
      if (hudScaleIdx === -1) hudScaleIdx = 1;
    }

    // ======== הקלטה ========
    btnRec.addEventListener('click', () => {
      // אם לא ביקשנו עדיין GPS – זה הזמן
      requestGeo();
      startRecording();
    });
    btnStop.addEventListener('click', stopRecording);

    function startRecording() {
      if (recording) return;
      const stream = canvas.captureStream(30);
      try {
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9,opus' });
      } catch (e) {
        alert('הדפדפן לא תומך בהקלטת וידאו מהסוג הזה.');
        return;
      }
      chunks = [];
      mediaRecorder.ondataavailable = ev => {
        if (ev.data.size > 0) chunks.push(ev.data);
      };
      mediaRecorder.onstop = onRecordingStop;
      mediaRecorder.start();
      recording = true;
      btnRec.classList.add('hidden');
      btnStop.classList.remove('hidden');
    }

    function stopRecording() {
      if (!recording) return;
      mediaRecorder.stop();
      recording = false;
      btnStop.classList.add('hidden');
      btnRec.classList.remove('hidden');
    }

    function onRecordingStop() {
      const blob = new Blob(chunks, { type: 'video/webm' });
      const url = URL.createObjectURL(blob);

      // iOS – לפתוח בחלון חדש כדי שיוכל לשמור
      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      if (isIOS) {
        window.open(url, '_blank');
      } else {
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'ski-speed-video.webm';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 2000);
      }
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 4000);
    }

    // ======== לולאת ציור ========
    function drawLoop() {
      if (cam.readyState >= 2) {
        // נשמור יחס: נצייר את הוידאו בקנבס 1:1
        ctx.drawImage(cam, 0, 0, canvas.width, canvas.height);

        // לצייר את ה-HUD במיקום שלו
        const hudRect = hud.getBoundingClientRect();
        const bodyRect = document.body.getBoundingClientRect();
        const x = hudRect.left - bodyRect.left;
        const y = hudRect.top - bodyRect.top;
        const w = hudRect.width;
        const h = hudRect.height;

        // רקע לבן שקוף בוידאו
        ctx.fillStyle = 'rgba(255,255,255,0.9)';
        ctx.fillRect(x, y, w, h);

        // טקסט
        ctx.fillStyle = '#000';
        ctx.font = '10px Arial';
        ctx.fillText('LIVE SPEED', x + 6, y + 13);

        ctx.font = 'bold 34px Arial';
        ctx.fillText(latestSpeed.toString(), x + 6, y + 55);
        ctx.font = '12px Arial';
        ctx.fillText('KM/H', x + 6, y + 70);

        // סגמנטים בצד ימין
        const segW = 9;
        const segH = 20;
        const gap = 4;
        const baseX = x + w - segW - 6;
        const baseY = y + 20;
        const speeds = [
          {limit: 1, color: 'rgba(0,0,0,0.08)'},
          {limit: 25, color: '#3bd385'},
          {limit: 45, color: '#00c8ff'},
          {limit: 70, color: '#2b7cff'},
          {limit: 100, color: '#ff4a4a'},
          {limit: 130, color: '#000'}
        ];
        // נצבע לפי מהירות
        for (let i = 0; i < 5; i++) {
          let color = 'rgba(0,0,0,0.08)';
          if (latestSpeed >= 100 && i === 4) color = '#000';
          else if (latestSpeed >= 70 && i === 3) color = '#ff4a4a';
          else if (latestSpeed >= 45 && i === 2) color = '#2b7cff';
          else if (latestSpeed >= 25 && i === 1) color = '#00c8ff';
          else if (latestSpeed >= 1 && i === 0) color = '#3bd385';
          ctx.fillStyle = color;
          ctx.fillRect(baseX, baseY + i*(segH+gap), segW, segH);
        }
      }
      requestAnimationFrame(drawLoop);
    }
  </script>
</body>
</html>