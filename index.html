<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>סקי וידאו עם מהירות</title>

  <!-- SEO -->
  <meta name="description" content="אפליקציית וידאו לסקי שמראה מהירות בזמן אמת ושומרת את הסרטון עם המד." />
  <meta name="keywords" content="סקי, סנובורד, מהירות, מצלמה, וידאו, PWA, גלישה, ski video, speed overlay" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <meta name="theme-color" content="#000000" />
  <!-- כאן תדביק את המטא של גוגל אם צריך -->
  <!-- <meta name="google-site-verification" content="XXXXXX" /> -->

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <style>
    :root {
      --hud-bg: rgba(255,255,255,0.95);
      --hud-text: #000;
      --seg-off: rgba(0,0,0,0.08);
      --seg-green: #33ce7f;
      --seg-cyan: #00c0ff;
      --seg-blue: #2b7cff;
      --seg-red: #ff4a4a;
      --seg-black: #000;
    }
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      min-height: 100vh;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      overscroll-behavior: none;
    }
    .app {
      position: fixed;
      inset: 0;
      background: #000;
      overflow: hidden;
    }
    video#cam {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #000;
    }
    canvas#rec {
      display: none;
    }

    /* חסימת מחשב */
    .desktop-block {
      position: fixed;
      inset: 0;
      background: #000;
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
      z-index: 9999;
      font-size: 16px;
      line-height: 1.5;
    }

    /* הוראות פתיחה */
    .intro-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    .intro-box {
      background: #fff;
      color: #000;
      border-radius: 16px;
      width: min(90%, 360px);
      padding: 20px 16px 16px 16px;
      text-align: center;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
    }
    .intro-title {
      font-weight: 700;
      margin-bottom: 10px;
      font-size: 17px;
    }
    .intro-text {
      font-size: 13px;
      line-height: 1.4;
      margin-bottom: 16px;
    }
    .intro-btn {
      display: inline-block;
      background: #000;
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
    }

    /* HUD */
    .hud {
      position: absolute;
      z-index: 50;
      width: 140px;
      background: var(--hud-bg);
      border-radius: 18px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      padding: 10px 10px 14px 10px;
      touch-action: none;
      transform-origin: top left;
    }
    .hud-header {
      font-size: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: rgba(0,0,0,0.55);
      margin-bottom: 3px;
      pointer-events: none;
    }
    .hud-speed-row {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      margin-bottom: 3px;
      pointer-events: none;
    }
    .hud-value {
      font-size: 38px;
      line-height: .9;
      font-weight: 700;
      color: var(--hud-text);
      pointer-events: none;
    }
    .hud-unit {
      font-size: 11px;
      font-weight: 600;
      color: rgba(0,0,0,0.55);
      margin-bottom: 4px;
      pointer-events: none;
    }
    .hud-segments {
      display: flex;
      flex-direction: column;
      gap: 4px;
      width: 10px;
      margin-left: auto;
      pointer-events: none;
    }
    .hud-segment {
      width: 100%;
      height: 19px;
      border-radius: 999px;
      background: var(--seg-off);
    }

    /* כפתורים */
    .controls {
      position: absolute;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      z-index: 60;
    }
    .rec-btn {
      width: 78px;
      height: 78px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #00d1ff 0%, #0066ff 75%);
      border: 3px solid rgba(255,255,255,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 8px 22px rgba(0,119,255,0.4);
    }
    .rec-btn svg {
      width: 30px;
      height: 30px;
      fill: #fff;
      pointer-events: none;
    }
    .stop-btn {
      width: 78px;
      height: 78px;
      border-radius: 18px;
      background: rgba(0,0,0,0.35);
      border: 2px solid rgba(255,0,0,0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .stop-btn svg {
      width: 26px;
      height: 26px;
      fill: #ff4444;
      pointer-events: none;
    }
    .hidden { display: none !important; }

    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 9px 14px;
      border-radius: 8px;
      font-size: 13px;
      display: none;
      z-index: 2000;
    }

    @media (max-width: 500px) {
      .hud {
        width: 130px;
      }
      .hud-value {
        font-size: 34px;
      }
    }
  </style>
</head>
<body>
  <div id="desktopBlock" class="desktop-block">
    האפליקציה הזו עובדת רק במובייל (iPhone / Android).<br>
    פתח את הקישור מהטלפון.
  </div>

  <div id="app" class="app">
    <video id="cam" playsinline autoplay muted></video>
    <canvas id="rec" width="1280" height="720"></canvas>

    <!-- HUD (נע למיקום + דאבל טאפ להגדלה) -->
    <div id="hud" class="hud">
      <div class="hud-header">LIVE SPEED</div>
      <div class="hud-speed-row">
        <div>
          <div id="hudVal" class="hud-value">0</div>
          <div class="hud-unit">KM/H</div>
        </div>
        <div class="hud-segments">
          <div id="seg1" class="hud-segment"></div>
          <div id="seg2" class="hud-segment"></div>
          <div id="seg3" class="hud-segment"></div>
          <div id="seg4" class="hud-segment"></div>
          <div id="seg5" class="hud-segment"></div>
        </div>
      </div>
    </div>

    <!-- כפתורי הקלטה -->
    <div class="controls">
      <div id="btnRec" class="rec-btn" title="התחל הקלטה">
        <svg viewBox="0 0 24 24">
          <path d="M8 5v14l11-7z" />
        </svg>
      </div>
      <div id="btnStop" class="stop-btn hidden" title="עצור ושמור">
        <svg viewBox="0 0 24 24">
          <rect x="6" y="6" width="12" height="12" rx="1" />
        </svg>
      </div>
    </div>

    <!-- הוראות פתיחה -->
    <div id="intro" class="intro-overlay">
      <div class="intro-box">
        <div class="intro-title">הפעלת האפליקציה</div>
        <div class="intro-text">
          1. תאפשר מצלמה ומיקום.<br>
          2. גרור את מד המהירות איפה שאתה רוצה.<br>
          3. דאבל־טאץ’ על המד כדי לשנות גודל.<br>
          4. לחץ על הכפתור כדי לצלם.
        </div>
        <button id="introBtn" class="intro-btn">הבנתי</button>
      </div>
    </div>

    <div id="toast" class="toast">הוידאו מוכן. אם אתה באייפון – פתח ושמור ידנית.</div>
  </div>

  <script>
    // ===== זיהוי מובייל =====
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const desktopBlock = document.getElementById('desktopBlock');
    if (!isMobile) {
      desktopBlock.style.display = 'flex';
    }

    // ===== אלמנטים =====
    const cam = document.getElementById('cam');
    const canvas = document.getElementById('rec');
    const ctx = canvas.getContext('2d');
    const hud = document.getElementById('hud');
    const hudVal = document.getElementById('hudVal');
    const segs = [
      document.getElementById('seg1'),
      document.getElementById('seg2'),
      document.getElementById('seg3'),
      document.getElementById('seg4'),
      document.getElementById('seg5')
    ];
    const btnRec = document.getElementById('btnRec');
    const btnStop = document.getElementById('btnStop');
    const intro = document.getElementById('intro');
    const introBtn = document.getElementById('introBtn');
    const toast = document.getElementById('toast');

    let latestSpeed = 0;
    let recording = false;
    let mediaRecorder = null;
    let chunks = [];
    let draggingHud = false;
    let dragOffsetX = 0, dragOffsetY = 0;
    let hudScaleIdx = 1;
    const hudScales = [0.85, 1, 1.25];

    // נשמור מיקום יחסית לאחוזים – זה מה שיתוקן לך
    let hudPos = {
      xPct: 3,   // אחוז מהשמאל
      yPct: 16,  // אחוז מהחלק העליון
      scale: 1
    };

    // שחזור אם קיים
    const savedHud = localStorage.getItem('ski_hud_pos_v2');
    if (savedHud) {
      hudPos = JSON.parse(savedHud);
    }

    function applyHudPosition() {
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      const left = (hudPos.xPct / 100) * vw;
      const top = (hudPos.yPct / 100) * vh;
      hud.style.left = left + 'px';
      hud.style.top = top + 'px';
      hud.style.transform = `scale(${hudPos.scale})`;
    }
    applyHudPosition();

    // ===== מצלמה =====
    async function startCam() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' },
          audio: {
            echoCancellation: false,
            noiseSuppression: false,
            autoGainControl: false
          }
        });
        cam.srcObject = stream;
        cam.onloadedmetadata = () => {
          cam.play();
          canvas.width = cam.videoWidth || 1280;
          canvas.height = cam.videoHeight || 720;
        };
        drawLoop();
      } catch (e) {
        alert('לא ניתן להפעיל מצלמה/מיקרופון. בדוק הרשאות.');
      }
    }
    startCam();

    // ===== GPS =====
    function requestGeo() {
      if (!("geolocation" in navigator)) return;
      navigator.geolocation.watchPosition(onGeo, err => {
        console.log('geo err', err);
      }, {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 8000
      });
    }

    let lastGeo = null;
    function onGeo(pos) {
      const { latitude, longitude, speed } = pos.coords;
      let kmh = 0;
      if (speed != null) {
        kmh = speed * 3.6;
      } else if (lastGeo) {
        const distKm = haversine(lastGeo.lat, lastGeo.lon, latitude, longitude);
        const dt = (pos.timestamp - lastGeo.t) / 1000;
        if (dt > 0) kmh = (distKm / (dt / 3600));
      }
      latestSpeed = Math.round(kmh * 0.6 + latestSpeed * 0.4);
      updateHUD(latestSpeed);
      lastGeo = { lat: latitude, lon: longitude, t: pos.timestamp };
    }
    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat/2)**2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function updateHUD(kmh) {
      hudVal.textContent = kmh;
      segs.forEach(s => s.style.background = 'var(--seg-off)');
      if (kmh >= 1) segs[0].style.background = 'var(--seg-green)';
      if (kmh >= 25) segs[1].style.background = 'var(--seg-cyan)';
      if (kmh >= 45) segs[2].style.background = 'var(--seg-blue)';
      if (kmh >= 70) segs[3].style.background = 'var(--seg-red)';
      if (kmh >= 100) segs[4].style.background = 'var(--seg-black)';
    }

    // ===== סגירת הוראות =====
    introBtn.addEventListener('click', () => {
      intro.style.display = 'none';
      localStorage.setItem('ski_intro_done', '1');
      requestGeo();
    });
    if (localStorage.getItem('ski_intro_done') === '1') {
      intro.style.display = 'none';
      requestGeo();
    }

    // ===== גרירת HUD =====
    hud.addEventListener('mousedown', startDragHud);
    hud.addEventListener('touchstart', startDragHud, {passive:false});
    function startDragHud(e) {
      draggingHud = true;
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      const rect = hud.getBoundingClientRect();
      dragOffsetX = clientX - rect.left;
      dragOffsetY = clientY - rect.top;
      e.preventDefault();
    }
    document.addEventListener('mousemove', dragHudMove);
    document.addEventListener('touchmove', dragHudMove, {passive:false});
    function dragHudMove(e) {
      if (!draggingHud) return;
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      let newLeft = clientX - dragOffsetX;
      let newTop = clientY - dragOffsetY;
      const maxLeft = window.innerWidth - hud.offsetWidth;
      const maxTop = window.innerHeight - hud.offsetHeight;
      if (newLeft < 0) newLeft = 0;
      if (newTop < 0) newTop = 0;
      if (newLeft > maxLeft) newLeft = maxLeft;
      if (newTop > maxTop) newTop = maxTop;
      hud.style.left = newLeft + 'px';
      hud.style.top = newTop + 'px';
      // נשמור אחוזים
      hudPos.xPct = (newLeft / window.innerWidth) * 100;
      hudPos.yPct = (newTop / window.innerHeight) * 100;
      saveHudPos();
      e.preventDefault();
    }
    document.addEventListener('mouseup', () => draggingHud = false);
    document.addEventListener('touchend', () => draggingHud = false);

    // דאבל טאפ להגדלה
    let lastTap = 0;
    hud.addEventListener('touchend', (e) => {
      const now = Date.now();
      if (now - lastTap < 300) {
        hudScaleIdx = (hudScaleIdx + 1) % hudScales.length;
        hudPos.scale = hudScales[hudScaleIdx];
        hud.style.transform = `scale(${hudPos.scale})`;
        saveHudPos();
      }
      lastTap = now;
    });

    function saveHudPos() {
      localStorage.setItem('ski_hud_pos_v2', JSON.stringify(hudPos));
    }

    // ===== הקלטה =====
    btnRec.addEventListener('click', startRecording);
    btnStop.addEventListener('click', stopRecording);

    function startRecording() {
      if (recording) return;

      // stream מהקנבס
      const canvasStream = canvas.captureStream(30);
      // להוסיף אודיו מהמצלמה
      const camStream = cam.srcObject;
      if (camStream) {
        const audioTracks = camStream.getAudioTracks();
        audioTracks.forEach(t => canvasStream.addTrack(t));
      }

      try {
        mediaRecorder = new MediaRecorder(canvasStream, {
          mimeType: 'video/webm;codecs=vp9,opus'
        });
      } catch (e) {
        alert('הדפדפן לא תומך בהקלטה מהסוג הזה.');
        return;
      }

      chunks = [];
      mediaRecorder.ondataavailable = ev => {
        if (ev.data.size > 0) chunks.push(ev.data);
      };
      mediaRecorder.onstop = onRecordingStop;
      mediaRecorder.start();
      recording = true;
      btnRec.classList.add('hidden');
      btnStop.classList.remove('hidden');
    }

    function stopRecording() {
      if (!recording) return;
      mediaRecorder.stop();
      recording = false;
      btnStop.classList.add('hidden');
      btnRec.classList.remove('hidden');
    }

    function onRecordingStop() {
      const blob = new Blob(chunks, { type: 'video/webm' });
      const url = URL.createObjectURL(blob);
      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      if (isIOS) {
        // באייפון – לפתוח בחלון חדש
        window.open(url, '_blank');
      } else {
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'ski-speed-video.webm';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 2000);
      }
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 4000);
    }

    // ===== ציור קבוע לקנבס =====
    function drawLoop() {
      if (cam.readyState >= 2) {
        // וידאו בגודל המקורי -> לא מותח
        ctx.drawImage(cam, 0, 0, canvas.width, canvas.height);

        // ציור HUD לפי אחוזים
        const x = (hudPos.xPct / 100) * canvas.width;
        const y = (hudPos.yPct / 100) * canvas.height;
        const scale = hudPos.scale || 1;
        const baseW = 140;
        const baseH = 95;
        const w = baseW * scale;
        const h = baseH * scale;

        // קופסה לבנה
        ctx.fillStyle = 'rgba(255,255,255,0.92)';
        ctx.fillRect(x, y, w, h);
        // טקסט
        ctx.fillStyle = '#000';
        ctx.font = `${10 * scale}px Arial`;
        ctx.fillText('LIVE SPEED', x + 6*scale, y + 13*scale);
        ctx.font = `${34 * scale}px Arial`;
        ctx.fillText(latestSpeed.toString(), x + 6*scale, y + 53*scale);
        ctx.font = `${12 * scale}px Arial`;
        ctx.fillText('KM/H', x + 6*scale, y + 68*scale);

        // סגמנטים
        const segW = 10 * scale;
        const segH = 18 * scale;
        const gap = 4 * scale;
        const baseX = x + w - segW - 6*scale;
        const baseY = y + 20*scale;
        function segColor(i) {
          if (latestSpeed >= 100 && i === 4) return '#000';
          if (latestSpeed >= 70 && i === 3) return '#ff4a4a';
          if (latestSpeed >= 45 && i === 2) return '#2b7cff';
          if (latestSpeed >= 25 && i === 1) return '#00c0ff';
          if (latestSpeed >= 1 && i === 0) return '#33ce7f';
          return 'rgba(0,0,0,0.08)';
        }
        for (let i=0;i<5;i++) {
          ctx.fillStyle = segColor(i);
          ctx.fillRect(baseX, baseY + i*(segH+gap), segW, segH);
        }
      }
      requestAnimationFrame(drawLoop);
    }
  </script>
</body>
</html>