<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>אפליקציית סקי עם מד מהירות וצילום</title>

  <!-- SEO אגרסיבי -->
  <meta name="description" content="אפליקציית וידאו לסקי/סנובורד שמראה מהירות בזמן אמת על המסך ושומרת את הסרטון עם המד. תומך PWA להתקנה בנייד." />
  <meta name="keywords" content="סקי, סנובורד, מד מהירות, מצלמה, אפליקציית סקי, צילום עם מהירות, PWA, וידאו, גלישה, ski, snowboard, speed overlay" />
  <meta name="robots" content="index, follow" />

  <!-- Open Graph -->
  <meta property="og:title" content="אפליקציית סקי עם מד מהירות" />
  <meta property="og:description" content="צלם את הגלישה ותראה את המהירות שלך חי על המסך." />
  <meta property="og:type" content="website" />
  <!-- כאן תחליף לתמונה שלך -->
  <meta property="og:image" content="https://example.com/ski-app-cover.png" />

  <!-- כאן תדביק את המטא של גוגל -->
  <!-- <meta name="google-site-verification" content="XXXXXXX" /> -->

  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <meta name="theme-color" content="#000000" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <!-- schema.org בסיסי -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "אפליקציית סקי עם מד מהירות",
    "applicationCategory": "SportsApplication",
    "operatingSystem": "iOS, Android, Web",
    "description": "צילום וידאו בזמן גלישה והצגת מהירות בזמן אמת",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "ILS"
    }
  }
  </script>

  <style>
    :root {
      --hud-bg: rgba(0,0,0,0.15);
      --hud-panel: rgba(5,7,10,0.6);
      --hud-line: rgba(0,214,255,0.9);
      --hud-white: #ffffff;
      --hud-green: #36d995;
      --hud-blue: #00c0ff;
      --hud-red: #ff4a4a;
      --hud-black: #000000;
      --record-btn: linear-gradient(140deg,#00d5ff,#0085ff);
      --danger: #ff4747;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      min-height: 100vh;
      touch-action: manipulation;
      overscroll-behavior: none;
    }
    .app-shell {
      position: fixed;
      inset: 0;
      background: #000;
      overflow: hidden;
    }
    video#camera {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #000;
    }
    canvas#recorder {
      display: none;
    }

    /* חלון הוראות חד פעמי */
    .startup-help {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    .startup-box {
      background: radial-gradient(circle at top, #101820 0%, #05080c 80%);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      width: min(88%, 380px);
      padding: 16px 16px 12px 16px;
    }
    .startup-title {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .startup-icon {
      width: 28px;
      height: 28px;
      background: rgba(0,214,255,0.15);
      border: 1px solid rgba(0,214,255,0.4);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .startup-list {
      font-size: 13px;
      line-height: 1.35;
      color: rgba(255,255,255,0.83);
      margin-bottom: 12px;
    }
    .startup-close {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      background: #00bfff;
      border: none;
      padding: 7px 14px;
      border-radius: 999px;
      font-weight: bold;
      cursor: pointer;
      font-size: 13px;
    }

    /* מד מהירות בסגנון HUD שמאלי */
    .speed-hud {
      position: absolute;
      top: 20%;
      left: 12px;
      width: 120px;
      height: 210px;
      z-index: 50;
      touch-action: none;
      transform-origin: center center;
    }
    .speed-hud-body {
      position: relative;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.05);
    }
    .speed-hud svg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }
    .speed-value-big {
      position: absolute;
      bottom: 50px;
      left: 16px;
      font-size: 40px;
      font-weight: 700;
      text-shadow: 0 0 9px rgba(0,0,0,0.6);
      letter-spacing: -1px;
    }
    .speed-unit {
      position: absolute;
      bottom: 30px;
      left: 18px;
      font-size: 14px;
      color: rgba(255,255,255,0.8);
      letter-spacing: 1px;
    }
    .hud-handle {
      position: absolute;
      bottom: -14px;
      right: -14px;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: rgba(0,0,0,0.7);
      border: 1px solid rgba(255,255,255,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: se-resize;
      z-index: 10;
    }
    .hud-handle svg {
      width: 16px;
      height: 16px;
      fill: #fff;
    }

    /* כפתורי הקלטה */
    .controls {
      position: absolute;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      z-index: 100;
    }
    .rec-btn {
      width: 78px;
      height: 78px;
      border-radius: 50%;
      background: var(--record-btn);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 25px rgba(0,214,255,0.35);
      cursor: pointer;
      border: 3px solid rgba(255,255,255,0.4);
    }
    .rec-btn svg {
      width: 30px;
      height: 30px;
      fill: #fff;
    }
    .stop-btn {
      width: 78px;
      height: 78px;
      border-radius: 20px;
      background: rgba(0,0,0,0.35);
      border: 2px solid rgba(255,0,0,0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .stop-btn svg {
      width: 26px;
      height: 26px;
      fill: #ff4a4a;
    }
    .hidden { display: none !important; }

    /* טוסט */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 9px 14px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 999;
      display: none;
    }

    @media (max-width: 500px) {
      .speed-hud {
        width: 108px;
        height: 185px;
      }
      .speed-value-big {
        font-size: 34px;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <video id="camera" playsinline autoplay muted></video>
    <canvas id="recorder" width="1280" height="720"></canvas>

    <!-- חלון הוראות חד פעמי (נשמר ב-localStorage) -->
    <div id="startup" class="startup-help">
      <div class="startup-box">
        <div class="startup-title">
          <div class="startup-icon">
            <!-- svg קטן -->
            <svg viewBox="0 0 24 24" width="18" height="18">
              <path fill="#00d5ff" d="M12 2L2 7l10 5 9-4.5V17h2V7L12 2zm0 13L5 10.5v4L12 19l7-4.5v-4L12 15z"/>
            </svg>
          </div>
          <div>איך משתמשים</div>
        </div>
        <div class="startup-list">
          1. תאפשר מצלמה ומיקום.<br>
          2. גרור את מד המהירות איפה שאתה רוצה על המסך.<br>
          3. אפשר להגדיל עם העיגול הקטן למטה.<br>
          4. לחץ צילום – המהירות שתראה זה מה שישמר בווידאו.<br>
        </div>
        <button id="startupClose" class="startup-close">
          <svg viewBox="0 0 24 24" width="14" height="14">
            <path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
          </svg>
          הבנתי
        </button>
      </div>
    </div>

    <!-- HUD מהירות -->
    <div id="hud" class="speed-hud">
      <div class="speed-hud-body">
        <!-- SVG של קשת עם חלקים (לא העתק של התמונה) -->
        <svg viewBox="0 0 120 210" preserveAspectRatio="xMidYMid meet">
          <!-- רקע קשת -->
          <path d="M10 200 C 10 80 40 30 95 10" fill="none" stroke="rgba(255,255,255,0.12)" stroke-width="8" stroke-linecap="round" />
          <!-- קו צבע שמתמלא נצייר בקנבס, כאן רק סימונים -->
          <path d="M16 192 C 16 90 42 42 90 20" fill="none" stroke="rgba(0,214,255,0.4)" stroke-width="3" stroke-linecap="round" stroke-dasharray="3 8" />
          <!-- סימוני מספרים -->
          <text x="30" y="60" fill="rgba(255,255,255,0.18)" font-size="11">100</text>
          <text x="18" y="105" fill="rgba(255,255,255,0.18)" font-size="11">70</text>
          <text x="14" y="150" fill="rgba(255,255,255,0.18)" font-size="11">40</text>
          <text x="12" y="188" fill="rgba(255,255,255,0.5)" font-size="11">0</text>
        </svg>
        <div id="speedVal" class="speed-value-big">0</div>
        <div class="speed-unit">KM/H</div>
      </div>
      <div id="hudHandle" class="hud-handle" title="הגדלה/הקטנה">
        <svg viewBox="0 0 24 24">
          <path d="M3 21h6v-2H5v-4H3v6zm4-8h2V7h4V5H7v8zm8 8h6v-6h-2v4h-4v2zm2-8h2V7h-6v2h4v4z"/>
        </svg>
      </div>
    </div>

    <!-- כפתורים -->
    <div class="controls">
      <div id="recordBtn" class="rec-btn" title="התחל הקלטה">
        <!-- play svg -->
        <svg viewBox="0 0 24 24">
          <path d="M8 5v14l11-7z" />
        </svg>
      </div>
      <div id="stopBtn" class="stop-btn hidden" title="עצור ושמור">
        <svg viewBox="0 0 24 24">
          <rect x="6" y="6" width="12" height="12" rx="1" ry="1"></rect>
        </svg>
      </div>
    </div>

    <div id="toast" class="toast">הוידאו נוצר. אם לא נפתח - לחץ על ההורדה.</div>
  </div>

  <script>
    // ******* SERVICE WORKER ********
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(console.warn);
    }

    // ******* אלמנטים *******
    const cam = document.getElementById('camera');
    const canvas = document.getElementById('recorder');
    const ctx = canvas.getContext('2d');
    const hud = document.getElementById('hud');
    const hudHandle = document.getElementById('hudHandle');
    const speedVal = document.getElementById('speedVal');
    const recordBtn = document.getElementById('recordBtn');
    const stopBtn = document.getElementById('stopBtn');
    const toast = document.getElementById('toast');
    const startup = document.getElementById('startup');
    const startupClose = document.getElementById('startupClose');

    // ******* הוראות חד פעמי *******
    if (localStorage.getItem('skiApp_seenHelp') === '1') {
      startup.style.display = 'none';
    }
    startupClose.addEventListener('click', () => {
      startup.style.display = 'none';
      localStorage.setItem('skiApp_seenHelp', '1');
    });

    // ******* מצב כללי *******
    let latestSpeed = 0; // km/h
    let recording = false;
    let recorder = null;
    let chunks = [];
    let hudScale = 1;
    let draggingHud = false;
    let dragOffX = 0, dragOffY = 0;
    let resizing = false;
    let baseWidth = 120; // ליחס הגדלה
    let geoLast = null;

    // ******* הפעלת מצלמה *******
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' },
          audio: true
        });
        cam.srcObject = stream;
        cam.onloadedmetadata = () => {
          cam.play();
          // להתאים קנבס לגודל הווידאו האמיתי
          canvas.width = cam.videoWidth || 1280;
          canvas.height = cam.videoHeight || 720;
        };
        drawFrame();
      } catch (e) {
        alert('לא ניתן לפתוח מצלמה. בדוק הרשאות.');
        console.log(e);
      }
    }
    startCamera();

    // ******* GPS מהירות משופר *******
    if ("geolocation" in navigator) {
      navigator.geolocation.watchPosition(onGeo, err => {
        console.log('geo error', err);
      }, {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 8000
      });
    }
    function onGeo(pos) {
      const { latitude, longitude, speed } = pos.coords;
      let kmh = 0;
      if (speed != null) {
        kmh = Math.max(0, speed * 3.6); // m/s -> km/h
      } else if (geoLast) {
        // חישוב לפי מרחק זמן
        const d = haversine(geoLast.lat, geoLast.lon, latitude, longitude); // בק"מ
        const dt = (pos.timestamp - geoLast.t) / 1000; //שניות
        if (dt > 0) {
          kmh = (d / (dt / 3600)); // קמ"ש
        }
      }
      // עדכון עם החלקה כדי שלא יקפוץ
      latestSpeed = Math.round(kmh * 0.6 + latestSpeed * 0.4);
      updateHud(latestSpeed);
      geoLast = { lat: latitude, lon: longitude, t: pos.timestamp };
    }
    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371; // km
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // ******* עדכון HUD *******
    function updateHud(kmh) {
      speedVal.textContent = kmh;
      // אפשר כאן לשנות צבע outline לפי טווח, אבל את הקו אנחנו נצייר על הקנבס
    }

    // ******* גרירת HUD *******
    hud.addEventListener('mousedown', startHudDrag);
    hud.addEventListener('touchstart', startHudDrag, {passive:false});
    function startHudDrag(e) {
      // אם לוחצים על הידית – לא לגרור
      if (e.target === hudHandle) return;
      draggingHud = true;
      const rect = hud.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      dragOffX = clientX - rect.left;
      dragOffY = clientY - rect.top;
      e.preventDefault();
    }
    document.addEventListener('mousemove', moveHud);
    document.addEventListener('touchmove', moveHud, {passive:false});
    function moveHud(e) {
      if (!draggingHud) return;
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      let newLeft = clientX - dragOffX;
      let newTop = clientY - dragOffY;
      // גבולות
      const maxLeft = window.innerWidth - hud.offsetWidth;
      const maxTop = window.innerHeight - hud.offsetHeight;
      if (newLeft < 0) newLeft = 0;
      if (newTop < 0) newTop = 0;
      if (newLeft > maxLeft) newLeft = maxLeft;
      if (newTop > maxTop) newTop = maxTop;
      hud.style.left = newLeft + 'px';
      hud.style.top = newTop + 'px';
      e.preventDefault();
      // נשמור
      saveHudPos();
    }
    document.addEventListener('mouseup', () => draggingHud = false);
    document.addEventListener('touchend', () => draggingHud = false);

    // ******* הגדלה/הקטנה *******
    hudHandle.addEventListener('mousedown', e => {
      resizing = true;
      e.stopPropagation();
    });
    hudHandle.addEventListener('touchstart', e => {
      resizing = true;
      e.stopPropagation();
    }, {passive:false});
    document.addEventListener('mousemove', e => {
      if (!resizing) return;
      resizeHud(e.clientX, e.clientY);
    });
    document.addEventListener('touchmove', e => {
      if (!resizing) return;
      const t = e.touches[0];
      resizeHud(t.clientX, t.clientY);
    }, {passive:false});
    document.addEventListener('mouseup', () => resizing = false);
    document.addEventListener('touchend', () => resizing = false);
    function resizeHud(clientX, clientY) {
      const rect = hud.getBoundingClientRect();
      const dx = clientX - rect.left;
      const scale = Math.min(Math.max(dx / baseWidth, 0.6), 1.6);
      hudScale = scale;
      hud.style.transform = `scale(${hudScale})`;
      saveHudPos();
    }

    // שמירת מיקום/סקייל ב-localStorage
    function saveHudPos() {
      const rect = hud.getBoundingClientRect();
      localStorage.setItem('skiApp_hud', JSON.stringify({
        left: rect.left,
        top: rect.top,
        scale: hudScale
      }));
    }
    // שחזור
    const saved = localStorage.getItem('skiApp_hud');
    if (saved) {
      const data = JSON.parse(saved);
      hud.style.left = data.left + 'px';
      hud.style.top = data.top + 'px';
      hudScale = data.scale || 1;
      hud.style.transform = `scale(${hudScale})`;
    }

    // ******* הקלטה *******
    recordBtn.addEventListener('click', startRecording);
    stopBtn.addEventListener('click', stopRecording);

    function startRecording() {
      if (recording) return;
      // יצירת stream מהקנבס
      const stream = canvas.captureStream(30);
      recorder = new MediaRecorder(stream, {
        mimeType: 'video/webm;codecs=vp9,opus'
      });
      chunks = [];
      recorder.ondataavailable = ev => {
        if (ev.data.size > 0) chunks.push(ev.data);
      };
      recorder.onstop = onRecordingStop;
      recorder.start();
      recording = true;
      recordBtn.classList.add('hidden');
      stopBtn.classList.remove('hidden');
    }

    function stopRecording() {
      if (!recording) return;
      recorder.stop();
      recording = false;
      stopBtn.classList.add('hidden');
      recordBtn.classList.remove('hidden');
    }

    function onRecordingStop() {
      const blob = new Blob(chunks, {type: 'video/webm'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = 'ski-speed-video.webm';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 3000);
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 4000);
    }

    // ******* לולאת ציור -> כאן אנחנו שורפים על הקנבס גם את הוידאו וגם את המד *******
    function drawFrame() {
      if (cam.readyState >= 2) {
        // שרטוט וידאו
        ctx.drawImage(cam, 0, 0, canvas.width, canvas.height);

        // להוסיף את HUD במיקום על המסך
        const hudRect = hud.getBoundingClientRect();
        const appRect = document.body.getBoundingClientRect();
        const x = hudRect.left - appRect.left;
        const y = hudRect.top - appRect.top;
        const w = hudRect.width;
        const h = hudRect.height;

        // רקע חצי שקוף
        ctx.save();
        ctx.globalAlpha = 0.28;
        ctx.fillStyle = '#000';
        ctx.fillRect(x, y, w, h);
        ctx.restore();

        // מסגרת
        ctx.strokeStyle = 'rgba(0,214,255,0.55)';
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, w, h);

        // טקסט של מהירות
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 30px Arial';
        ctx.fillText(latestSpeed.toString(), x + 16, y + h - 50);
        ctx.font = '14px Arial';
        ctx.fillStyle = 'rgba(255,255,255,0.7)';
        ctx.fillText('KM/H', x + 16, y + h - 30);

        // פס אנכי צבעוני לפי מהירות
        const maxBar = h - 50;
        const perc = Math.min(latestSpeed / 120, 1);
        const barHeight = perc * maxBar;
        let color = '#36d995';
        if (latestSpeed <= 30) color = '#36d995';
        else if (latestSpeed <= 55) color = '#00c0ff';
        else if (latestSpeed <= 100) color = '#ff4a4a';
        else color = '#000000';
        ctx.fillStyle = color;
        ctx.fillRect(x + w - 12, y + (maxBar - barHeight) + 20, 6, barHeight);

      }
      requestAnimationFrame(drawFrame);
    }
  </script>
</body>
</html>